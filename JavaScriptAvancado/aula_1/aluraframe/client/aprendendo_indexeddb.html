<!DOCTYPE html>
<html lang="pt-BR" dir="ltr">
  <head>
    <meta charset="utf-8"/>
    <title>aprendendo IndexedDB</title>
  </head>
  <body>
    <script type="text/javascript" src="./js/app/models/Negociacao.js"></script>
    <script type="text/javascript" src="./js/app/services/ConnectionFactory.js"></script>
    <script type="text/javascript">
      var connection;

      var openRequest = window.indexedDB.open(dbName, version);

      openRequest.onupgradeneeded = evento =>{
          connection = evento.target.result;
          console.log('cria ou altera um banco já existente');

          stores.forEach((store) => {
            if(connection.objectStoreNames.contains(store)){
              connection.deleteObjectStore(store);
            }
            connection.createObjectStore(store, { autoIncrement: true });
          });
        }
      openRequest.onsuccess = evento => {
        console.log('conexão obtida com sucesso');

        connection = evento.target.result;

      };

      openRequest.onerror = evento =>
        console.log(evento.target.error);

      function adiciona() {

        let transaction = connection.transaction(stores,'readwrite');

        let store = transaction.objectStore('negociacoes');

        let negociacao = new Negociacao(new Date(), 200, 1);

        let request = store.add(negociacao);

        request.onsuccess = evento => {
          console.log("Negociação incluída com sucesso");
        }

        request.onerror = evento => {
          console.log("Não foi possível incluir a Negociação");
        }

      }

      function listaTodos(){
        let transation = connection.transaction(['negociacoes'], 'readwrite');

        let store = transation.objectStore('negociacoes');

        let negociacoes = [];

        let cursor = store.openCursor();

        cursor.onsuccess = evento => {
          let atual = evento.target.result;

          if(atual){

            let dado = atual.value;

            negociacoes.push(new Negociacao(dado._data, dado._quantidade, dado._valor));

            atual.continue();

          }else{

            console.log(negociacoes);

          }
        };

        cursor.onerror = evento => {
          console.log('erro');
        };
      }

      ConnectionFactory
        .getConnection()
        .then(connection => {

        });

      ConnectionFactory
        .getConnection()
        .then(connection => {

        });
    </script>
  </body>
</html>
